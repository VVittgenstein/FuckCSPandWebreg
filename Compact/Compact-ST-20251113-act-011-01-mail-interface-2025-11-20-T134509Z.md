# Compact â€“ ST-20251113-act-011-01-mail-interface

## Implemented facts
- Contract doc (`docs/mail_sender_contract.md`) defines `MailSender` interface with `send` and optional `verify`, `MailMessage` payload (locale, templateId/templateVersion, variables, unsubscribe/manage links, dedupeKey/traceId passthrough, attachments), `SendOptions` (timeouts, provider override, rateLimitKey, dryRun) and `SendResult` (`sent|retryable|failed`, provider, message id, retryAfterSeconds, typed error codes like validation_error/template_missing_locale/rate_limited/network_error/etc.). Operational errors return structured `SendResult` instead of throws.
- Validation rules spelled out: locale must be supported; template + locale must exist; required variables enforced; recipient normalized/validated; dedupe/trace headers forwarded when provider supports.
- Config sample added (`configs/mail_sender.example.json`): default provider SendGrid with env-ref API key; SMTP profile with host/port/secure/pool and env-ref password; shared defaults for from/replyTo, supportedLocales, templateRoot, templates (open-seat + verification with locale-specific subject/html/text paths and requiredVariables), rateLimit (maxPerSecond/burst), retryPolicy (attempts/backoff/jitter + retryable error codes), timeouts, logging redaction/trace header, and testHooks (dryRun/overrideRecipient).
- Security/ops requirements captured: secrets via env refs, TLS/timeout/pooling expectations, PII redaction in logs, enforce unsubscribe/manage links, verified From domain alignment.
- Validation/test guidance listed: config validation at load, template completeness unit tests, provider adapter contract tests with stubs + retry classification, dry-run/override CLI smoke, structured logging/metrics for observability.
- Subtask status flipped to `done` in `record.json` with updated timestamp; task updated accordingly.

## Interfaces / behavior changes
- Establishes canonical MailSender payload/result/error schema and config fields for future provider adapters and workers; downstream code should conform to these names/semantics (e.g., `SendResult.status`, `SendErrorCode` set) and load secrets from env vars referenced in config.
- Template layout expectations defined: per-locale subject/html/text paths under `templateRoot`, with requiredVariables list driving validation.

## Risks / TODO / limits
- No runtime code or adapters implemented yet; contract not enforced by schemas/validators in code.
- Self-test not run (docs/config only); template files referenced in sample do not exist yet.
- Compliance items rely on implementers (redaction, unsubscribe links, TLS settings) to honor contract.

## Validation
- Tests not run (doc/config change only).

## Code Review - ST-20251113-act-011-01-mail-interface - 2025-11-20T13:49:45Z
Codex Review: Didn't find any major issues. Can't wait for the next one!
