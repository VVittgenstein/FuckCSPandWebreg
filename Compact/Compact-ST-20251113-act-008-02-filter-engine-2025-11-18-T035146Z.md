# Compact - ST-20251113-act-008-02-filter-engine

## 已落实事实
- `api/src/queries/course_search.ts:89` 新增 `executeCourseSearch`，以 better-sqlite3 构建 term/campus/subject 起始过滤，支持 level、courseNumber、核心代码、学分区间、delivery、hasOpenSection、meetingDays+meetingStart/End、instructor、requiresPermission 等组合条件，并通过 FTS (`course_search_fts`) 提供关键字匹配；所有条件使用参数化绑定避免 SQL 注入。
- `api/src/queries/course_search.ts:240` 同一查询根据 sortBy/sortDir 计算排序列与默认方向，落盘分页 LIMIT/OFFSET，并默认附加 subject+courseNumber 稳定排序；`buildIncludeSet`/`attachSectionsSummary` 额外拼装 subject 元数据及 section 汇总（总数、开放数、delivery 去重列表）。
- `api/src/routes/courses.ts:65` 将 `/api/courses` handler 切换到实际查询：在 Fastify request 上获取容器 SQLite 连接、调用 `executeCourseSearch`、按查询结果填充 `meta.total` 与 `hasNext` 逻辑，同时返回真实 `data` 列表。
- `api/tests/course_search.test.ts:1` 通过 node:test 在内存 SQLite 创建最小 schema/FTS/meetings/sections，覆盖核心过滤（核心代码+hasOpenSection、delivery+meeting、跨 campus instructor、FTS + 分页排序、include=sectionsSummary+subjects、requiresPermission true/false）；确保查询构建器能过滤到预期课程。

## 接口 / 行为变更
- `/api/courses` 现在会直接读取 SQLite 数据库，响应 `data` 包含课程及可选 subject/sectionsSummary 扩展，`meta.total/hasNext` 依赖真实计数；调用方需保证底层库包含 `courses`, `course_core_attributes`, `sections`, `section_meetings`, `course_search_fts`, `subjects` 等表。

## 限制 / 风险 / TODO
- 查询依赖 `course_search_fts`（MATCH）与 `subjects` left join；若部署数据库缺少对应虚表或索引，路由会抛错，需要在迁移流程里确保这些对象存在。
- `/api/sections` 仍返回空数组（上一子任务遗留），未实现的 section 级筛选可能阻断 ACT-008 的后续验收。

## 自测
- `npx tsx api/tests/course_search.test.ts` ✅ 所有 6 个 node:test 用例通过，覆盖主要过滤组合与 include 扩展。
