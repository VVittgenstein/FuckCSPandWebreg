# Compact - ST-20251113-act-008-01-contract

## 已落实事实
- `docs/query_api_contract.md:1` 给出本地查询 API 的契约（/api/health、/api/courses、/api/sections、/api/filters），说明了筛选参数、分页 envelope、错误格式与默认排序规则。
- `api/src/config.ts:1` / `api/src/container.ts:1` 使用 Zod 校验 APP_PORT/APP_HOST/LOG_LEVEL/SQLITE_FILE 等环境变量，并提供延迟初始化的 better-sqlite3 连接（WAL + FK），便于后续依赖注入。
- `api/src/server.ts:1` 构建 Fastify + zod type-provider 的服务骨架，统一错误处理、在 onClose 阶段释放容器、并把所有路由挂在 `/api` 前缀下。
- `api/src/plugins/requestLogging.ts:1` 提供请求/响应日志中间件，记录 reqId、method/url、status 及耗时，满足基本可观测性要求。
- `api/src/routes/sharedSchemas.ts:1` 定义分页、布尔、时间、枚举等查询参数 helpers；`api/src/routes/courses.ts:14` 与 `api/src/routes/sections.ts:14` 复用这些 schema 做严格校验并输出 `{meta,data}` 结构；`api/src/routes/filters.ts:5`、`api/src/routes/health.ts:5` 分别返回过滤项占位数据与 SQLite ping 结果。
- `api/src/types/fastify.d.ts:1` / `tsconfig.json:1` 让 TypeScript 能识别自定义 `app.container` 并编译 `api/src/**`。
- `package.json:10` 引入 fastify/fastify-plugin/fastify-type-provider-zod/zod 依赖及 `api:start`/`api:dev` 脚本，为运行骨架服务提供入口。

## 接口 / 行为变更
- 新增 `/api/health`, `/api/courses`, `/api/sections`, `/api/filters` 端点和对应查询参数契约；所有列表响应统一返回 `meta`+`data` 包装，前端/worker 需按文档消费（`docs/query_api_contract.md:13`, `api/src/routes/*.ts`).
- 服务实例现在依赖 `APP_PORT`, `APP_HOST`, `LOG_LEVEL`, `SQLITE_FILE` 等环境变量，并要求 SQLite 文件已存在（`api/src/config.ts:5`, `api/src/container.ts:16`).

## 限制 / 风险 / TODO
- `/api/courses` 与 `/api/sections` 目前只返回空数组和分页 meta，占位注释指向后续筛选实现；尚未查询 SQLite（`api/src/routes/courses.ts:85`, `api/src/routes/sections.ts:85`).
- `/api/filters` 仅返回静态空列表/默认枚举，需要接入 terms/campuses/subjects/coreCodes 表才能满足 UI（`api/src/routes/filters.ts:5`).
- `npx tsc --noEmit` 因既有 `scripts/fetch_soc_data.ts` 的严格模式报错（map 回调类型不匹配，行 784/798）而失败，当前更改未能提供完全通过的 TypeScript build。

## 自测
- `npx tsc --noEmit` → **失败**，原因是 `scripts/fetch_soc_data.ts:784` 与 `scripts/fetch_soc_data.ts:798` 的类型声明早已不满足 strict 模式，需在后续修复或豁免后才能得到干净的构建。（本次改动的 `api/src/**` 能通过编译。）
