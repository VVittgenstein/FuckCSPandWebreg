# ST-20251113-act-004-02-bot-sending (compact)

## 已落实事实
- Discord 发送模块 `notifications/discord/bot.ts`：配置校验+env 取 token；全局/单频道 token-bucket 排队；DM 创建并缓存；429/5xx 重试+backoff；dry-run、override、mention 控制、雪花脱敏日志。
- 新增并发去重：`DiscordBot.send` 现按 `request.dedupeKey` 复用同一发送 promise，避免同 dedupe key 的重复发帖。
- CLI 验证脚本 `scripts/discord_send_test.ts`（`npm run discord:test-send`）支持 `--config --channel/--user --message [--dryRun --trace]`。
- 单测 `notifications/discord/tests/bot.test.ts` 覆盖默认频道发送、429 后重试成功、DM 创建发送、dedupeKey 并发去重；`DISCORD_BOT_TOKEN` 测试内注入。
- `package.json` 包含脚本 `discord:test-send`；record.json 将子任务标记已完成并挂载 Compact 记录。

## 接口/行为变更
- `DiscordBot.send(request)` 现支持 dedupeKey 去重；内部 `sendWithRetry` 同步重试逻辑。
- `loadDiscordBotConfig/resolveDiscordBotConfig` 仍为配置入口；CLI 命令新增为验证接口。

## 风险 / 未完成
- 本地未跑 node --test（环境缺少 node 可执行）；需在具备 Node 的环境执行 `node --test notifications/discord/tests/bot.test.ts`。
- 仍未对真实 Discord API 联调，真实 token/权限/速率需上线前验证。
