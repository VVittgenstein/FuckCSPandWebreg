# Compact — ST-20251113-act-008-03-api-hardening

## 已落实事实
- Fastify 统一错误处理：所有校验/运行时/404 响应都携带 `error.traceId`，并同步设置 `X-Trace-Id` 头用于日志关联（api/src/server.ts）。
- `/api/health` 现返回 SQLite 连通性与必需表（courses/sections/course_core_attributes/course_search_fts/section_meetings/subjects）状态；任一依赖降级即 `status:"degraded"`（api/src/routes/health.ts）。
- 新增 `/api/ready`，只要 SQLite 不可访问或上述表缺失即返回 `503`，并内嵌 `checks.sqlite`/`checks.tables.missing` 详情，便于编排层摘流（api/src/routes/health.ts）。
- `/api/courses` 与 `/api/sections` 会记录结构化 `query.metrics` 日志（duration、分页、过滤条件、匹配/返回数量），强化可观测性（api/src/routes/courses.ts, api/src/routes/sections.ts）。
- 文档新增错误结构、健康探针与运维注意事项说明（docs/query_api_contract.md），记录端口/env/限流建议。
- 新增集成测试验证 `/api/ready` 正常/失败路径及错误 trace id 头体一致性（api/tests/health.test.ts）。

## 接口 / 行为变更
- **新端点**：`GET /api/ready`，HTTP 200=>ready，503=>not_ready，响应体包含 `checks.sqlite`/`checks.tables`。
- **现有端点变化**：`GET /api/health` 继续 200，但增加 `schema` 依赖字段，当检测失败时 `status:"degraded"`。
- **错误响应**：所有错误 JSON 追加 `traceId`，客户端可读取同名 header；需对应前端/API 调用方更新解析逻辑。
- **日志**：`courses`/`sections` 查询会额外产出 `query.metrics` 事件（含过滤摘要），可供监控/报警消费。

## 自测
- `npx tsx --test "api/tests/**/*.test.ts"` ✅
  - 包含既有 `course_search` 单测和新增健康/trace id 测试，覆盖主要探针与错误路径。

## 风险 / TODO
- `/api/ready` 依赖静态表清单，若未来 schema 变更需同步更新 `REQUIRED_SCHEMA_TABLES` 与文档。
- 目前 `/api/sections` 仍返回空数据（历史限制），metrics 记录 total=0 仅用于观测；后续实现查询逻辑时需确保日志字段兼容。
- 未内建限流，仍需运维按文档建议在反向代理层实施。

## Code Review - ST-20251113-act-008-03-api-hardening - 2025-11-18T04:49:21Z
Codex Review: Didn't find any major issues. 👍
