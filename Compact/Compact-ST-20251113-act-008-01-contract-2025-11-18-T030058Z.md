# Compact - ST-20251113-act-008-01-contract

## å·²è½å®äº‹å®
- `docs/query_api_contract.md:1` ä»å®šä¹‰ /api/healthã€/api/coursesã€/api/sectionsã€/api/filters çš„æŸ¥è¯¢å‚æ•°ã€åˆ†é¡µ envelopeã€é”™è¯¯ç»“æ„ä¸é»˜è®¤æ’åºï¼Œæä¾›è·¨ç«¯ä¸€è‡´çš„å¥‘çº¦è¯´æ˜ã€‚
- `api/src/config.ts:1`ã€`api/src/container.ts:1` é€šè¿‡ Zod æ ¡éªŒç¯å¢ƒå˜é‡å¹¶æ‡’åŠ è½½ better-sqlite3ï¼ˆWAL + å¤–é”®ï¼‰ï¼Œ`tsconfig.json:1` å°† `api/src/**`/d.ts çº³å…¥ç¼–è¯‘ï¼Œä¿è¯å®¹å™¨/ç±»å‹åœ¨ TS å±‚å¯ç”¨ã€‚
- `api/src/server.ts:18` åˆ›å»º Fastify + Zod Type Provider çš„æœåŠ¡éª¨æ¶ï¼ŒåŒæ—¶æ³¨å†Œ `validatorCompiler`/`serializerCompiler`ï¼Œç¡®ä¿è·¯ç”± schema ä¼šç”± Zod çœŸæ­£æ‰§è¡Œæ ¡éªŒå¹¶è¿”å›å¥‘çº¦ä¸­çš„ `VALIDATION_FAILED` é”™è¯¯ï¼›åŒæ–‡ä»¶ç¬¬ 58 è¡Œæ–°å¢è‡ªå®šä¹‰ `setNotFoundHandler`ï¼Œæ‰€æœ‰æœªçŸ¥è·¯ç”±éƒ½è¿”å› `{ error: { code: "NOT_FOUND", ... } }` envelopeã€‚
- `api/src/plugins/requestLogging.ts:6` ä»ä¸ºæ‰€æœ‰è¯·æ±‚è®°å½• reqId/method/status/è€—æ—¶ï¼Œ`api/src/routes/sharedSchemas.ts:1` é›†ä¸­å®šä¹‰åˆ†é¡µã€å¸ƒå°”ã€æ—¶é—´ã€æšä¸¾ç­‰å‚æ•° helperã€‚
- `api/src/routes/courses.ts:14` ä¸ `api/src/routes/sections.ts:14` å¤ç”¨è¿™äº› schemaï¼Œæ ¡éªŒ term/campus/meetingStart/meetingEnd ç­‰ç»„åˆå¹¶æä¾› `{ meta, data }` å“åº”ï¼›`api/src/routes/filters.ts:5`ã€`api/src/routes/health.ts:5` è¿”å›è¿‡æ»¤é¡¹å ä½ä¸ SQLite å¥åº·æ£€æŸ¥ã€‚
- `package.json:10` åŒ…å«è¿è¡Œè„šæœ¬ `api:start`/`api:dev` åŠ fastify + zod ä¾èµ–ï¼Œä¿è¯éª¨æ¶æœåŠ¡å¯å¯åŠ¨ã€‚

## æ¥å£ / è¡Œä¸ºå˜æ›´
- Fastify ç°ä¸¥æ ¼éµå¾ª Zod schemaï¼šæ‰€æœ‰æŸ¥è¯¢å‚æ•°ï¼ˆåŒ…å« credits/meeting rangesï¼‰ä¼šåœ¨è¿›å…¥ handler å‰è¢«è§£æ/éªŒè¯ï¼Œè¿çº¦è¯·æ±‚è¿”å› `400` + `error.code=VALIDATION_FAILED`ï¼ˆ`api/src/server.ts:18-38`, `api/src/routes/*.ts`).
- æœªæ³¨å†Œçš„è·¯å¾„ç»Ÿä¸€è¿”å› `{ error: { code: "NOT_FOUND", message } }`ï¼Œä¸å¥‘çº¦ `docs/query_api_contract.md:189-205` ä¸€è‡´ï¼ˆ`api/src/server.ts:58-65`).

## é™åˆ¶ / é£é™© / TODO
- `/api/courses`ã€`/api/sections` ä»è¿”å›ç©ºæ•°æ®ï¼Œå ä½æ³¨é‡Šç­‰å¾…ç­›é€‰å±‚å®ç°ï¼›`/api/filters` ä»…å«é™æ€æšä¸¾ï¼Œéœ€è¦æ¥å…¥ SQLite è¯å…¸ï¼ˆ`api/src/routes/courses.ts:96`, `api/src/routes/sections.ts:96`, `api/src/routes/filters.ts:12`).
- `npx tsc --noEmit` ä»å› æ—¢æœ‰ `scripts/fetch_soc_data.ts` åœ¨è¡Œ 784/798 çš„ `map` ç±»å‹æ¨æ–­é—®é¢˜å¤±è´¥ï¼›æœ¬ Subtask çš„ API æºç ç¼–è¯‘é€šè¿‡ä½† CI ä¾æ—§ä¼šçº¢ï¼Œéœ€è¦åœ¨åç»­ä»»åŠ¡ä¿®å¤è¯¥è„šæœ¬æˆ–è°ƒæ•´ tsconfigã€‚

## è‡ªæµ‹
- `npx tsc --noEmit` â†’ **å¤±è´¥**ï¼ˆåŒå‰ï¼š`scripts/fetch_soc_data.ts:784` ä¸ `:798` ä¸­çš„ `map` å›è°ƒå‚æ•°ç±»å‹ä¸º `unknown`ï¼Œéœ€å¤–éƒ¨ä¿®å¤ï¼›æœ¬æ¬¡æ”¹åŠ¨æœªæ–°å¢é¢å¤–é”™è¯¯ï¼‰ã€‚

## Code Review - ST-20251113-act-008-01-contract - 2025-11-18T03:02:00Z
#1
api/src/server.ts
Comment on lines +18 to +22


  const app = Fastify({
    logger: {
      level: config.logLevel,
    },
  }).withTypeProvider<ZodTypeProvider>();


@chatgpt-codex-connector
chatgpt-codex-connector bot

P1 Badge Wire Zod schemas into Fastify validation

createServer enables the Zod type provider but never registers the fastify-type-provider-zod validator/serializer compilers, so Fastify falls back to its default AJV handling of the schema objects. Zod schemas in the route definitions are therefore treated as opaque JSON and no parsing/refinement runs, meaning invalid queries (e.g., missing term or meetingStart>meetingEnd) will be accepted instead of returning the documented VALIDATION_FAILED errors in docs/query_api_contract.md. Add the providerâ€™s compilers so runtime validation matches the contract.

#2
api/src/server.ts
Comment on lines +26 to +30


  app.setErrorHandler((error: unknown, request, reply) => {
    if (error instanceof ZodError) {
      const details = error.issues.map((issue) => `${issue.path.join('.') || 'root'}: ${issue.message}`);
      return reply.status(400).send({
        error: {


@chatgpt-codex-connector
chatgpt-codex-connector bot  
P2 Badge NotFound responses bypass documented error envelope

The contract (docs/query_api_contract.md lines 189-205) states errors should return { error: { code, message, details? } }, including 404s, but createServer only sets a generic error handler and never overrides Fastifyâ€™s default not-found handler. Hitting an unknown path will return Fastifyâ€™s { statusCode, error, message } payload rather than the promised { error: { code: "NOT_FOUND", ... } }, so clients relying on the documented shape will fail to parse 404s.

## Code Review - ST-20251113-act-008-01-contract - 2025-11-18T03:06:52Z
---review-start---
Codex Review: Didn't find any major issues. ğŸ‘
---review-end---
