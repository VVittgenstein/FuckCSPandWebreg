# Compact - ST-20251113-act-008-01-contract

## 已落实事实
- `docs/query_api_contract.md:1` 仍定义 /api/health、/api/courses、/api/sections、/api/filters 的查询参数、分页 envelope、错误结构与默认排序，提供跨端一致的契约说明。
- `api/src/config.ts:1`、`api/src/container.ts:1` 通过 Zod 校验环境变量并懒加载 better-sqlite3（WAL + 外键），`tsconfig.json:1` 将 `api/src/**`/d.ts 纳入编译，保证容器/类型在 TS 层可用。
- `api/src/server.ts:18` 创建 Fastify + Zod Type Provider 的服务骨架，同时注册 `validatorCompiler`/`serializerCompiler`，确保路由 schema 会由 Zod 真正执行校验并返回契约中的 `VALIDATION_FAILED` 错误；同文件第 58 行新增自定义 `setNotFoundHandler`，所有未知路由都返回 `{ error: { code: "NOT_FOUND", ... } }` envelope。
- `api/src/plugins/requestLogging.ts:6` 仍为所有请求记录 reqId/method/status/耗时，`api/src/routes/sharedSchemas.ts:1` 集中定义分页、布尔、时间、枚举等参数 helper。
- `api/src/routes/courses.ts:14` 与 `api/src/routes/sections.ts:14` 复用这些 schema，校验 term/campus/meetingStart/meetingEnd 等组合并提供 `{ meta, data }` 响应；`api/src/routes/filters.ts:5`、`api/src/routes/health.ts:5` 返回过滤项占位与 SQLite 健康检查。
- `package.json:10` 包含运行脚本 `api:start`/`api:dev` 及 fastify + zod 依赖，保证骨架服务可启动。

## 接口 / 行为变更
- Fastify 现严格遵循 Zod schema：所有查询参数（包含 credits/meeting ranges）会在进入 handler 前被解析/验证，违约请求返回 `400` + `error.code=VALIDATION_FAILED`（`api/src/server.ts:18-38`, `api/src/routes/*.ts`).
- 未注册的路径统一返回 `{ error: { code: "NOT_FOUND", message } }`，与契约 `docs/query_api_contract.md:189-205` 一致（`api/src/server.ts:58-65`).

## 限制 / 风险 / TODO
- `/api/courses`、`/api/sections` 仍返回空数据，占位注释等待筛选层实现；`/api/filters` 仅含静态枚举，需要接入 SQLite 词典（`api/src/routes/courses.ts:96`, `api/src/routes/sections.ts:96`, `api/src/routes/filters.ts:12`).
- `npx tsc --noEmit` 仍因既有 `scripts/fetch_soc_data.ts` 在行 784/798 的 `map` 类型推断问题失败；本 Subtask 的 API 源码编译通过但 CI 依旧会红，需要在后续任务修复该脚本或调整 tsconfig。

## 自测
- `npx tsc --noEmit` → **失败**（同前：`scripts/fetch_soc_data.ts:784` 与 `:798` 中的 `map` 回调参数类型为 `unknown`，需外部修复；本次改动未新增额外错误）。

## Code Review - ST-20251113-act-008-01-contract - 2025-11-18T03:02:00Z
#1
api/src/server.ts
Comment on lines +18 to +22


  const app = Fastify({
    logger: {
      level: config.logLevel,
    },
  }).withTypeProvider<ZodTypeProvider>();


@chatgpt-codex-connector
chatgpt-codex-connector bot

P1 Badge Wire Zod schemas into Fastify validation

createServer enables the Zod type provider but never registers the fastify-type-provider-zod validator/serializer compilers, so Fastify falls back to its default AJV handling of the schema objects. Zod schemas in the route definitions are therefore treated as opaque JSON and no parsing/refinement runs, meaning invalid queries (e.g., missing term or meetingStart>meetingEnd) will be accepted instead of returning the documented VALIDATION_FAILED errors in docs/query_api_contract.md. Add the provider’s compilers so runtime validation matches the contract.

#2
api/src/server.ts
Comment on lines +26 to +30


  app.setErrorHandler((error: unknown, request, reply) => {
    if (error instanceof ZodError) {
      const details = error.issues.map((issue) => `${issue.path.join('.') || 'root'}: ${issue.message}`);
      return reply.status(400).send({
        error: {


@chatgpt-codex-connector
chatgpt-codex-connector bot  
P2 Badge NotFound responses bypass documented error envelope

The contract (docs/query_api_contract.md lines 189-205) states errors should return { error: { code, message, details? } }, including 404s, but createServer only sets a generic error handler and never overrides Fastify’s default not-found handler. Hitting an unknown path will return Fastify’s { statusCode, error, message } payload rather than the promised { error: { code: "NOT_FOUND", ... } }, so clients relying on the documented shape will fail to parse 404s.
