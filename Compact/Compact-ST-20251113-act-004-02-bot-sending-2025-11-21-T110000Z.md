# ST-20251113-act-004-02-bot-sending

- Added Discord bot sender (`notifications/discord/bot.ts`) with config loader, token-bucket throttling, DM/channel resolution, retry/backoff on 429/5xx, and redacted logging.
- CLI helper `scripts/discord_send_test.ts` (`npm run discord:test-send -- --config <path> --channel <id> --message "text"`) sends verification pings with optional dry-run/trace.
- Node test (`notifications/discord/tests/bot.test.ts`) stubs fetch to cover success, rate-limit retry, and DM channel creation flows.

## Code Review - ST-20251113-act-004-02-bot-sending - 2025-11-21T11:21:20Z

notifications/discord/bot.ts
Comment on lines +190 to +195
export type DiscordSendRequest = {
  target: DiscordTarget;
  message: DiscordMessagePayload;
  traceId?: string;
  dedupeKey?: string;
};
@chatgpt-codex-connector
chatgpt-codex-connector bot
13 minutes ago
P2 Badge Respect dedupeKey when sending Discord messages

The Discord sender exposes a dedupeKey on DiscordSendRequest (notifications/discord/bot.ts:190-195), but the send implementation never looks at it, so concurrent calls with the same dedupe key will all enqueue separate posts. The Discord strategy doc (docs/discord_strategy.md:41) calls for deduplicating by open_event.dedupe_key to avoid duplicate alerts within the window. As written, callers that expect provider-level dedupe will produce multiple Discord messages for the same event, wasting rate-limit budget and spamming users.
