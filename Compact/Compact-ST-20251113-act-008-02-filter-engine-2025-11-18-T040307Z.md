# Compact - ST-20251113-act-008-02-filter-engine

## å·²è½å®äº‹å®
- `api/src/queries/course_search.ts:89` çš„ `executeCourseSearch` è´Ÿè´£è§£æ `/api/courses` çš„ SQLite æŸ¥è¯¢ï¼šterm/campus/subject ä¸ºåŸºç¡€ WHEREï¼Œä» `courses`/`course_core_attributes`/`sections`/`section_meetings`/`course_search_fts`/`subjects` ç»„åˆè¿‡æ»¤ï¼Œæ”¯æŒ levelã€courseNumberã€æ ¸å¿ƒä»£ç ã€å­¦åˆ†åŒºé—´ã€hasOpenSectionã€instructorã€requiresPermissionã€deliveryã€meetingDays+meetingStart/Endï¼Œä¸”å…¨éƒ¨ä½¿ç”¨å‚æ•°åŒ–ç»‘å®šã€‚
- æœ€æ–°ä¿®å¤ï¼ˆ`api/src/queries/course_search.ts:153`ï¼‰æŠŠ delivery ä¸ meeting æ¡ä»¶åˆå¹¶è¿›åŒä¸€ä¸ª `EXISTS` å­å¥å¹¶åœ¨éœ€è¦æ—¶è”æ¥ `section_meetings`ï¼Œç¡®ä¿åªæœ‰åŒä¸€ section åŒæ—¶æ»¡è¶³ delivery å’Œæ—¶é—´çº¦æŸæ—¶è¯¾ç¨‹æ‰è¢«è¿”å›ï¼Œæ¶ˆé™¤äº†â€œä¸åŒ section æ··åˆå‘½ä¸­â€çš„è¯¯åˆ¤ã€‚
- æ’åº/åˆ†é¡µä»ç”± `resolveSort` å’Œ LIMIT/OFFSET æ§åˆ¶ï¼Œå¹¶å¯é€‰é™„åŠ  subject å…ƒæ•°æ®ä¸ section æ±‡æ€»ï¼ˆ`sectionsSummary`ï¼‰ï¼›`api/src/routes/courses.ts:65` å·²ä¸Šçº¿çœŸå®æ•°æ®å“åº”ä¸ `meta.total/hasNext` è®¡ç®—ã€‚
- `api/tests/course_search.test.ts:1` çš„ node:test å¥—ä»¶ä¼šåœ¨å†…å­˜ SQLite ä¸­å»ºè¡¨é€ æ•°ï¼Œè¦†ç›–æ ¸å¿ƒç»„åˆç­›é€‰ã€FTS/paginationã€include æ‰©å±•ä»¥åŠ requiresPermission é€»è¾‘ï¼Œå›å½’éªŒè¯äº¤ä»˜ã€‚

## æ¥å£ / è¡Œä¸ºå˜æ›´
- `/api/courses` ç›´æ¥è¯»å– SQLite å¹¶è¿”å›çœŸå®è¯¾ç¨‹åˆ—è¡¨ï¼›å½“è¯·æ±‚åŒæ—¶æŒ‡å®š `delivery` ä¸ `meetingDays/meetingStart/meetingEnd` æ—¶ï¼Œåªæœ‰åŒä¸€ä¸ª section åŒæ—¶æ»¡è¶³ä¸¤ç±»è¿‡æ»¤æ‰ä¼šå‡ºç°åœ¨ç»“æœé‡Œã€‚

## é™åˆ¶ / é£é™© / TODO
- ä¾èµ– `course_search_fts` ä¸ `subjects` è¡¨çš„ JOIN/MATCHï¼›è‹¥éƒ¨ç½²æœªå®Œæˆè¿ç§»æˆ– FTS æœªæ„å»ºï¼Œä¼šå¯¼è‡´æŸ¥è¯¢æŠ¥é”™ï¼Œéœ€è¦åœ¨ DB å‘å¸ƒæµç¨‹ä¸­ç¡®ä¿å­˜åœ¨ã€‚
- `/api/sections` ä»æ˜¯ç©ºå®ç°ï¼ˆä¸Šä¸€å­ä»»åŠ¡é—ç•™ï¼‰ï¼ŒACT-008 åç»­é‡Œç¨‹ç¢‘ä»éœ€è¡¥å…… section çº§è¿‡æ»¤ã€‚

## è‡ªæµ‹
- `npx tsx api/tests/course_search.test.ts` âœ… 6 ä¸ª node:test ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼Œè¦†ç›– delivery+meeting è”åˆç­›é€‰åŠå…¶ä»–ç»„åˆè¿‡æ»¤ã€‚

## Code Review - ST-20251113-act-008-02-filter-engine - 2025-11-18T04:07:46Z

---review-start---
api/src/queries/course_search.ts
Comment on lines +181 to +185


      EXISTS (
        SELECT 1
        FROM sections s_meeting
        JOIN section_meetings sm ON sm.section_id = s_meeting.section_id
        WHERE s_meeting.course_id = c.course_id${meetingFilter}


@chatgpt-codex-connector
chatgpt-codex-connector bot

P1 Badge Delivery and meeting filters not intersected per section

The delivery filter and the meetingDays/time filter are implemented as two separate EXISTS clauses over different section aliases, so when both filters are supplied a course will pass if one section matches the delivery method and a different section matches the time/day mask. This yields false positives: a course with one online section and another in-person Monday section will still be returned for delivery=online&meetingDays=M even though no single section satisfies both filters.
---review-end---

## Code Review - ST-20251113-act-008-02-filter-engine - 2025-11-18T04:08:52Z

---review-start---
Codex Review: Didn't find any major issues. ğŸ‰
---review-end---
