# Compact â€“ ST-20251113-act-010-02-polling-worker (refresh)

## Implemented facts
- openSections poller (`workers/open_sections_poller.ts`): per-campus loop with jittered cadence, SOC fetch, snapshot writes, section status toggles, status events, open_event insert, and subscription fan-out in pages; uses missThreshold to debounce closes.
- Closure handling fixed: even when openSections returns an empty list, closure branch now runs once miss thresholds are met, removing snapshots and resetting subscriptions; prevents lingering OPEN state when a campus legitimately has no open sections.
- Event storage migration renamed to `data/migrations/003_open_events.sql` to avoid prefix collision; defines `open_events` and `open_event_notifications` tables plus indexes/unique constraints. `record.json` artifact updated accordingly.
- Fan-out filters pending/active subscriptions, respects delivery window/snooze pref parsing, dedupes via unique constraint, updates `subscriptions.last_known_section_status='OPEN'` on queue insert.
- Metrics endpoint optional; emits counters/gauges for polls, failures, events, notifications, last duration, and last open count per campus. `tsconfig.json` includes `workers/**/*`.
- Subtask marked done in `record.json`.

## Interfaces / behavior changes
- New migration version `003_open_events.sql` must be applied before running poller.
- Poller closure semantics: empty openSections responses no longer suppress closures; may generate CLOSED events/notification resets when all sections go closed.
- CLI entrypoint unchanged (`tsx workers/open_sections_poller.ts ...`), uses existing SQLite + SOC endpoints; optional `/metrics`.

## Risks / TODO / limits
- Typecheck still fails in repo due to pre-existing issues (`api/src/routes/subscriptions.ts` arity, `scripts/fetch_soc_data.ts` map typings); poller not fully validated via runtime tests.
- No automated tests added for worker; channel senders/locks remain out of scope.

## Validation
- `npx tsc --noEmit` previously failed on unrelated files; not rerun after this small fix. No runtime test executed.

## Code Review - ST-20251113-act-010-02-polling-worker - 2025-11-20T09:10:47Z

---review-start---
#1
workers/open_sections_poller.ts
Comment on lines +676 to +678


  // treat empty responses as soft outages to avoid false closes
  const skipClosures = indexes.length === 0 && toOpen.length === 0;



@chatgpt-codex-connector
chatgpt-codex-connector bot

P1 Badge Do not skip closures on empty openSections payloads

When an openSections probe returns an empty array, skipClosures short-circuits the closure branch even after missThreshold has been exceeded. Because the miss map deletes entries when the threshold is reached, this leaves previously open sections stuck as OPEN and their subscriptions updated to OPEN indefinitely until a new open index appears. For campuses that legitimately have no open sections, closures and related notifications will never be emitted, leaving stale state.

#2
data/migrations/002_open_events.sql
Comment on lines +1 to +4


-- Tables to capture open section events and notification fan-out queue
CREATE TABLE IF NOT EXISTS open_events (
    open_event_id INTEGER PRIMARY KEY AUTOINCREMENT,
    section_id INTEGER,


@chatgpt-codex-connector
chatgpt-codex-connector bot

P1 Badge Give new migration a new version prefix

This migration is numbered 002_open_events.sql, but data/migrations already contains 002_relax_section_index_scope.sql. The migration runner uses the numeric prefix as the version primary key in schema_migrations, so adding a second 002 will cause the second file to fail to apply with a unique constraint error and block database setup.
---review-end---

## Code Review - ST-20251113-act-010-02-polling-worker - 2025-11-20T09:14:42Z

---review-start---
BetterCourseSchedulePlanner/workers/open_sections_poller.ts

Lines 746 to 748 in d029a34



 return { 
   opened: toOpen.length, 
   closed: skipClosures ? 0 : toClose.length, 



P1 Badge Undefined skipClosures crashes poller
The return block still references skipClosures, but the variable was removed a few lines above. TypeScript will flag this as an undeclared identifier, and if run under ts-node/tsx the worker will throw a ReferenceError when applySnapshot returns, aborting every poll cycle after processing closures. Restoring a definition or removing the conditional is needed to avoid runtime failure.
---review-end---

## Code Review - ST-20251113-act-010-02-polling-worker - 2025-11-20T09:24:03Z

---review-start---
Codex Review: Didn't find any major issues. Already looking forward to the next diff.
---review-end---

## Code Review - ST-20251113-act-010-02-polling-worker - 2025-11-20T09:18:19Z

---review-start---
BetterCourseSchedulePlanner/workers/open_sections_poller.ts

Lines 746 to 748 in d029a34



 return { 
   opened: toOpen.length, 
   closed: skipClosures ? 0 : toClose.length, 



P1 Badge Undefined skipClosures crashes poller
The return block still references skipClosures, but the variable was removed a few lines above. TypeScript will flag this as an undeclared identifier, and if run under ts-node/tsx the worker will throw a ReferenceError when applySnapshot returns, aborting every poll cycle after processing closures. Restoring a definition or removing the conditional is needed to avoid runtime failure.
---review-end---
