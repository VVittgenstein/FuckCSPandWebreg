# Compact - ST-20251113-act-011-03-retry-tuning

## 已落实
- 邮件配置类型扩展：新增 `RateLimitConfig` 与 `RetryPolicyConfig`，`ResolvedMailSenderConfig` 现在必含这两块并在 zod loader 中校验/提供默认值（默认 5 qps、burst 10、3 次重试、jitter 0.25，仅对 rate_limited/network/provider/unknown 重试）。
- 新增可靠性封装 `notifications/mail/retry_policy.ts`：基于 token-bucket 限流（maxPerSecond/burst/bucketWidthSeconds）排队请求并记录 `waitMs`；`ReliableMailSender` 为同一 `dedupeKey` 复用在途 promise，按策略重试（遵循 backoffMs 与 retryAfterSeconds、可加 jitter），并返回 `SendWithRetryResult` 含每次尝试的时间戳/耗时/下一次延迟。
- 文档 `docs/mail_sender_usage.md` 给出快速用法示例、行为说明（限流、重试、幂等）、推荐配置与排障要点。

## 接口/行为变更
- 构造 MailSender 依赖的配置对象需携带 `rateLimit`/`retryPolicy`（否则使用 loader 默认）；`ReliableMailSender.send` 返回 `{ finalResult, attempts[] }` 而非直接 `SendResult`。
- 使用 `dedupeKey` 的并发发送会被折叠到同一发送链路，避免重复投递时的额外速率占用。

## 风险/限制
- 可靠性封装尚未在现有 worker 中强制接线；默认限流 5 qps/10 burst 可能需按实际配额调整。
- 异常捕获以 `unknown` 重试分类处理，仍需上层日志/告警确认根因。

## 自测
- `npx --yes tsx notifications/mail/tests/provider.test.ts`
- `npx --yes tsx notifications/mail/tests/retry_policy.test.ts`

## Code Review - ST-20251113-act-011-03-retry-tuning - 2025-11-20T15:35:47Z
Codex Review: Didn't find any major issues. You're on a roll.
