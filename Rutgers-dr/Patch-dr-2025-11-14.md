## Patch 2025-11-14

### 课程筛选与通知架构改进方案

#### 静态前端筛选方案的问题回顾
- 原方案（方案B）采用纯前端加载 20–40MB 的 `courses.json` 完成多条件筛选，通知由云函数轮询触发，借鉴了 QuACS 等项目“在浏览器完成筛选逻辑以确保性能与可扩展性”的思路。[1][2][3]
- 静态站点托管成本低，前端筛选在本地运行避免服务器瓶颈，可满足高并发和零登录需求。[2][4]
- 随着支持多学期、多校区数据，`courses.json` 体积迅速增长，导致初始加载缓慢与内存占用过高。即使利用虚拟列表、Web Worker 等优化，在低端设备或移动端仍会卡顿。[5]
- 通知功能依赖前端发起订阅请求，云函数依据订阅轮询 `openSections` 接口。前端和通知各维护一份课程数据（JSON 与云函数内存），造成数据分散、增量更新困难与冗余。[6]
- 因此，与静态筛选、大 JSON 数据、前端触发订阅相关的任务已不再适配，需要整体调整。

##### 与旧架构强绑定需评估的任务
- **T-20251113-act-001-soc-json-scraper**：当前批量抓取课程并生成静态 JSON，后续应改为写入本地数据库。抓取逻辑保留，输出形式变更。[7]
- **T-20251113-act-002-frontend-filter-mvp**：纯前端筛选实现需重构，前端 UI 继续保留，但数据来源改为本地轻量 API 按需查询。[8]
- **T-20251113-act-003-mail-notify-function**：原云函数轮询 `openSections` 并发邮件，新架构要求在本地后台服务执行订阅、监测与邮件发送。[6]
- **前端订阅触发逻辑**：需提供订阅/退订 UI，并通过本地 API 写入数据库，替换旧有的前端直连或云函数写入方式。[9]

### 新架构概述：本地数据库驱动的筛选与通知

> 前端通过本地 API 查询 SQLite 数据库，每个部署环境内置后台进程负责课程数据更新与通知发送。

#### 核心组件
- **本地持久化数据库**：使用 SQLite 等嵌入式数据库存储课程信息与实时容量状态，作为单一可信源，支持局部更新与索引优化。[10]
- **前端-后端分离查询**：前端提供筛选 UI，通过本地 API 获取满足条件的数据子集。可在嵌入式 HTTP 服务（Node/Go/Python 等）上实现 REST 接口，降低前端数据传输负担。[14][15]
- **本地更新与通知进程**：后台进程定期抓取 Rutgers SOC 数据、调用 `openSections` 接口并发送邮件或 Discord 通知，统一数据来源避免重复存储。[6]
- **增量数据更新**：首次全量抓取后，每日或定期执行增量更新，利用 SQLite `UPSERT` 等能力，必要时清理过期学期数据保持体积可控。[16][17]
- **多平台通知支持**：支持 SendGrid、SMTP 等多种邮件服务，并可在本地运行 Discord Bot，提供频率节制与错误重试机制。[11][12][13]

#### 引入本地 API 服务层的必要性
- 浏览器不直接访问数据库文件，而是通过 REST/HTTP 接口（如 `GET /api/courses`、`POST /api/subscribe`、`DELETE /api/unsubscribe`）。
- 本地服务层可嵌入前端框架或独立进程运行，清晰分离展示与数据操作，便于维护契约并扩展功能。[14][15]

### 任务结构调整方案

#### 数据抓取与存储任务
- 扩展原抓取脚本任务，使其初始化/更新本地数据库。可新增“设计本地数据库模式与导入脚本”任务，定义课程、Section、订阅等表结构，并将抓取结果写入 SQLite。验收包括多学期/校区数据覆盖与随机抽查校验。[16][17]

#### 前端筛选与数据接口任务
- 将 T-20251113-act-002 重构为依赖本地 API 的筛选 UI。新增“实现本地课程查询 API”任务，提供院系列表、条件检索、分页等 REST 端点，满足 FR-01/02/03 的筛选需求，验收关注正确性与毫秒级响应性能。[18][24]

#### 订阅管理与通知任务
- 将 T-20251113-act-003 改为“本地邮件通知服务”，可拆为：
  - **订阅管理与存储**：前端订阅 UI + 后端接口，将 Email/Discord 标识与 Section 写入数据库。[19]
  - **本地空位轮询与通知**：常驻任务定期检查余量变化并发送通知，保持平均延迟 <30 秒、避免重复通知。[20]
- **T-20251113-act-004** 保留但调整为本地集成 Discord Bot，延续通知扩展目标并更新速率限制说明。[12][21][25]
- 新增“邮件发送模块多平台支持”子任务，通过配置切换 SendGrid 或 SMTP，确保错误处理与重试逻辑健壮。[11]

#### 部署与运行任务
- **T-20251113-act-006** 需更新为描述本地数据库驱动的前后端服务部署，涵盖数据库初始化、API 服务启动、环境变量配置（数据库路径、邮件密钥、Discord token 等），并建议使用 Docker 打包实现一键启动。[22][23][27]
- 说明每个实例无需中央服务器，自给自足提供筛选与通知。

### 具体任务变更与新增清单

#### 需要大幅修改或重写的任务
1. **T-20251113-act-001**：改名为“抓取 Rutgers SOC 数据并初始化本地数据库”，验收聚焦数据库内容而非 JSON 输出。[7][16]
2. **T-20251113-act-002**：改名为“基于本地查询 API 的课程列表与多维筛选”，保留 UI 要求但依赖 API 数据，性能目标拆分为查询与渲染两部分。[8][24]
3. **T-20251113-act-003**：重写为“本地定时任务实现课程空位邮件通知”，强调订阅接口、本地轮询与及时性指标。[6][20]
4. **前端订阅触发逻辑**：在上述任务描述中明确需通过本地 API 写入订阅表，替代旧有云端写法。[9]

#### 可保留但需调整描述的任务
- **T-20251113-act-004**：继续实现 Discord 通知渠道，但描述环境改为本地运行，并更新风险说明。[12][21][25]
- **T-20251113-act-005**：前端 i18n 架构保持原目标，仅需在实现阶段覆盖新增错误提示等文本。[26]
- **T-20251113-act-006**：部署文档任务保留，补充本地服务运行流程、配置说明与 CI/CD（如容器化）调整。[22][23][27]

#### 新增任务或子任务建议
- **设计本地数据库模式与增量更新机制**：定义表结构，编写比较脚本实现增量更新，保证更新期间查询不受影响，验收包含模拟状态变更测试。
- **实现本地课程查询 API 服务**：选用 Express/FastAPI 等框架提供 `/api/courses` 等端点，支持筛选参数、分页与索引优化，并通过并发测试验证性能。
- **实现订阅管理接口与本地存储**：前端提供订阅/退订入口，后端处理 `POST /api/subscribe`、`DELETE /api/unsubscribe`，验证数据库记录与前端行为一致。
- **本地空位轮询与通知发送**：采用定时任务库（如 `node-cron`、`APScheduler`）轮询 `openSections`，比对订阅表并发送通知，确保幂等与异常恢复能力。[20]
- **邮件发送模块多平台支持**：抽象邮件发送接口，实现 SendGrid 与 SMTP 适配器，多语言模板与错误重试，确保不同配置均可成功发送。[11]

### 推荐方案总结

#### 总体架构
- 推荐采用“前端 + 本地轻量服务 + 嵌入式数据库”的架构，实现数据维护、筛选查询与通知的一体化。[10][28]
- 每个部署实例包含前端、API 服务、本地数据库与后台任务，无需中央服务器协调。

#### 数据库选型
- 建议使用 SQLite：零配置、性能可靠、支持复杂查询与索引优化，便于分发与备份。对轻量部署可选 KV 存储，但在复杂筛选下不如 SQLite 便捷。[10]

#### 架构优势
- 按需查询避免大 JSON 带来的加载与内存问题。
- 各实例独立运行，提升鲁棒性与隐私合规。
- 增量更新提高数据同步及时性，筛选与通知共享单一数据源。
- 本地服务层提供扩展弹性，可轻松增加新筛选维度或通知渠道。

#### 对原有任务调整的概览
- 原 6 项任务中除 i18n 外均需调整：T-001、T-002 大幅重写以匹配本地数据库架构；T-003、T-004 将通知功能迁至本地执行；T-006 更新部署说明。新增的数据库、API、订阅、轮询任务填补原计划缺口，确保 backlog 与新架构对齐。[8][6][20]
- 完成调整后应重新评估 FR/NFR 需求，以确认新架构满足性能与可靠性预期。[18][20]

### 参考资料
- [1]–[3][9][10][14][15] 《DR结论.md》 file://file_000000007f0071f5b70d3d43eead23c0
- [4]–[8][11]–[13][16]–[28] `record.json` file://file_00000000617471fbbf0468f521c1b593
